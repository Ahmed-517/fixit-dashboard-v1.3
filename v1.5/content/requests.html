<h2 class="pt-3">الطلبات</h2>
<div class="table-responsive">
  <input type="text" id="myInput" onkeyup="myFunction()" placeholder="Search for names..">
  <table class="table table-striped table-sm" id="myTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)" scope="col">#</th>
        <th onclick="sortTable(1)" scope="col">تاريخ</th>
        <th onclick="sortTable(2)" scope="col">النوع</th>
        <th onclick="sortTable(3)" scope="col">مبنى</th>
        <th onclick="sortTable(4)" scope="col">حالة المشكة</th>
        <th scope="col">action</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>1,001</td>
        <td> / / </td>
        <td>كهربية</td>
        <td>روض الفرج</td>
        <td class="solved">محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,002</td>
        <td> / / </td>
        <td>نوع المشكلة</td>
        <td>الخلفاوي</td>
        <td class="unSolved">غير محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,003</td>
        <td> / / </td>
        <td>الشبكة</td>
        <td>الخلفاوي</td>
        <td class="unSolved">غير محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,003</td>
        <td> / / </td>
        <td>تثري</td>
        <td>روض الفرج</td>
        <td class="solved">محلولة</td>
        <td><button class="btn btn btn-close dRequest"></button></td>
      </tr>
      <tr>
        <td>1,004</td>
        <td>الجدول</td>
        <td>بيانات</td>
        <td>تنسيق</td>
        <td class="solved">محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,005</td>
        <td>قيمة</td>
        <td>مبهة</td>
        <td>الجدول</td>
        <td class="unSolved">غير محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,006</td>
        <td>قيمة</td>
        <td>توضيحية</td>
        <td>غنية</td>
        <td class="unSolved">غير محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,007</td>
        <td>تثري</td>
        <td>مفيدة</td>
        <td>معلومات</td>
        <td class="solved">محلولة</td>
        <td><button class="btn-sm btn btn-close dRequest"></button></td>
      </tr>
      <tr>
        <td>1,008</td>
        <td>بيانات</td>
        <td>عشوائية</td>
        <td>تثري</td>
        <td class="unSolved">غير محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,009</td>
        <td>تثري</td>
        <td>مبهة</td>
        <td>تصميم</td>
        <td class="unSolved">غير محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,010</td>
        <td>عشوائية</td>
        <td>غنية</td>
        <td>قيمة</td>
        <td class="unSolved">غير محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,011</td>
        <td>معلومات</td>
        <td>تثري</td>
        <td>توضيحية</td>
        <td class="solved">محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,012</td>
        <td>الجدول</td>
        <td>تثري</td>
        <td>تنسيق</td>
        <td class="unSolved">غير محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,013</td>
        <td>قيمة</td>
        <td>مبهة</td>
        <td>الجدول</td>
        <td class="unSolved">غير محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,014</td>
        <td>قيمة</td>
        <td>توضيحية</td>
        <td>غنية</td>
        <td class="solved">محلولة</td>
        <td><button class="btn-sm btn btn-danger dRequest">حذف</button></td>
      </tr>
      <tr>
        <td>1,015</td>
        <td>بيانات</td>
        <td>مفيدة</td>
        <td>معلومات</td>
        <td class="solved">محلولة</td>
        <td>
          <button class="btn-sm btn btn-primary dRequest">تعديل</button>
          <button class="btn-sm btn btn-danger dRequest">حذف</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<ul id="list">

</ul>

<!-- Button trigger modal -->


<!--
  Start 
  Modal
-->
<div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
  aria-labelledby="staticBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">
          Modal title
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <!-- Start Modal Body  -->
        <ul class="list-group list-group-flush">
          <li class="list-group-item">
            <div class="fw-bold">النوع</div>
            <div id="type"></div>
          </li>
          <li class="list-group-item">
            <div class="fw-bold">الطابق</div>
            <div id="floor"></div>
          </li>
          <li class="list-group-item">
            <div class="fw-bold">القاعة</div>
            <div id="room"></div>
          </li>
          <li class="list-group-item">
            <div class="fw-bold">الوقت</div>
            <div id="time"></div>
          </li>
          <li class="list-group-item">
            <div class="fw-bold">وصف المشكلة</div>
            <div id="description"></div>
          </li>
        </ul>

        <!-- Start Assign Tracking -->
        <div dir="rtl" class="wrapper">
          <ul class="StepProgress">
            <li class="StepProgress-item current"><strong>Post a contest</strong></li>
            <li class="StepProgress-item current"><strong>Post a contest</strong></li>
            <li class="StepProgress-item current"><strong>Post a contest</strong></li>
            <li class="StepProgress-item is-done">
              <strong>Award an entry</strong>
              <div>ffsdfafg</div>
              Got more entries that you love? Buy more entries anytime! Just hover on your favorite entry and click
              the Buy button
            </li>
            <li class="StepProgress-item current"><strong>Post a contest</strong></li>
      
            <li class="StepProgress-item">
              <strong>اسناد الى</strong>
              <button>button</button>
            </li>
      
            <li class="StepProgress-item"><strong>Post a contest</strong></li>
            <!-- <li class="StepProgress-item"><strong>Handover</strong></li>
              <li class="StepProgress-item"><strong>Provide feedback</strong></li> -->
          </ul>
        </div>
        <!-- End Assign Tracking -->


        <div id="innerModal"></div>


        <!-- End Modal Body  -->

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" data-bs-target="#exampleModalToggle2"
          data-bs-toggle="modal">تعديل</button>
      </div>
    </div>
  </div>
</div>
<!--
  End
  Modal
-->

<!-- Start Modal 2 -->
<div class="modal fade" id="exampleModalToggle2" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2"
  tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalToggleLabel2">تعديل الطلب</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Hide this modal and show the first with the button below.
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-target="#staticBackdrop" data-bs-toggle="modal">Back to first</button>
      </div>
    </div>
  </div>
</div>
<a class="btn btn-primary" data-bs-toggle="modal" href="#staticBackdrop" role="button">Open first modal</a>
<!-- End Modal 2 -->

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.9.1/firebase-analytics.js";
  import {
    createUserWithEmailAndPassword,
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    signOut
  } from 'https://www.gstatic.com/firebasejs/9.9.1/firebase-auth.js'
  import {
    getFirestore, collection, onSnapshot,
    addDoc, deleteDoc, doc,
    query, where, orderBy, serverTimestamp,
    getDoc,
    getDocs,
    updateDoc
  } from 'https://www.gstatic.com/firebasejs/9.9.1/firebase-firestore.js'
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAUxgEruPP38L-8o5wloQpzlIXBw1LLOv0",
    authDomain: "test-338f7.firebaseapp.com",
    databaseURL: "https://test-338f7-default-rtdb.firebaseio.com",
    projectId: "test-338f7",
    storageBucket: "test-338f7.appspot.com",
    messagingSenderId: "819712021026",
    appId: "1:819712021026:web:8b26a81c713873ccd1b07b",
    measurementId: "G-JE138SYG4F"
  };
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);

  // init services
  const db = getFirestore();
  const auth = getAuth();
  const user = auth.currentUser;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      // User is signed in, see docs for a list of available properties
      // https://firebase.google.com/docs/reference/js/firebase.User
      // const uid = user.uid;
      console.log('user is logged in');
      console.log(user);
      $('.login').remove();
      $('.homeAdmin').css('display', 'block');

    } else {
      // User is signed out
      // ...
      console.log('user is logged out');
    }
  });


  // Get data to requests
  const colRef = collection(db, 'requests');
  const colAssign = collection(db, 'requests');
  const list = document.querySelector('table tbody')
  onSnapshot(colRef, (snapshot) => {
    let books = []
    snapshot.docs.forEach((doc) => {
      books.push({ ...doc.data(), id: doc.id });
      console.log('ABCDEFGIJ');
      console.log(doc.id, " => ", doc.data().title);
      console.log(doc.id, " => ", doc.data().author);
      console.log('String is ', doc.toString());
      console.log('map is ', doc.data().assign);
      list.innerHTML +=
        `
			<tr>
        <td></td>
				<td>
					
				</td>
				<td>
					${doc.data().type}
				</td>
				<td>
					${doc.data().campus}
				</td>
				<td>
					${doc.data().status}
				</td>
        <td>
          <button request-id="${doc.id}" type="button" class="btn btn-primary edit-button" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
            تعديل
          </button>
          <button class="btn-sm btn btn-danger dRequest">حذف</button>
        </td>
			</tr>
		`;
    })
    console.log(books);
  })

  $('.dRequest').on('click', function () {
    $(this).parent().parent().remove();
  });

  function myFunction() {
    // Declare variables
    var input, filter, table, tr, td, i, txtValue;
    input = document.getElementById("myInput");
    filter = input.value.toUpperCase();
    table = document.getElementById("myTable");
    tr = table.getElementsByTagName("tr");

    // Loop through all table rows, and hide those who don't match the search query
    for (i = 0; i < tr.length; i++) {
      td = tr[i].getElementsByTagName("td")[0];
      if (td) {
        txtValue = td.textContent || td.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
  }

  // Start Sorting Table

  function sortTable(n) {
    var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
    table = document.getElementById("myTable");
    switching = true;
    // Set the sorting direction to ascending:
    dir = "asc";
    /* Make a loop that will continue until
    no switching has been done: */
    while (switching) {
      // Start by saying: no switching is done:
      switching = false;
      rows = table.rows;
      /* Loop through all table rows (except the
      first, which contains table headers): */
      for (i = 1; i < (rows.length - 1); i++) {
        // Start by saying there should be no switching:
        shouldSwitch = false;
        /* Get the two elements you want to compare,
        one from current row and one from the next: */
        x = rows[i].getElementsByTagName("TD")[n];
        y = rows[i + 1].getElementsByTagName("TD")[n];
        /* Check if the two rows should switch place,
        based on the direction, asc or desc: */
        if (dir == "asc") {
          if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
            // If so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
          }
        } else if (dir == "desc") {
          if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
            // If so, mark as a switch and break the loop:
            shouldSwitch = true;
            break;
          }
        }
      }
      if (shouldSwitch) {
        /* If a switch has been marked, make the switch
        and mark that a switch has been done: */
        rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
        switching = true;
        // Each time a switch is done, increase this count by 1:
        switchcount++;
      } else {
        /* If no switching has been done AND the direction is "asc",
        set the direction to "desc" and run the while loop again. */
        if (switchcount == 0 && dir == "asc") {
          dir = "desc";
          switching = true;
        }
      }
    }
  }
  // End Sorting Table

  // Delete Button
  $(document).on('click', '.delete-request', function () {
    console.log('delete button clicked');
  })

  // Edit Button 
  $(document).on('click', '.edit-button', function () {
    console.log(`edit button clicked ${this}`);

    let id = $(this).attr('request-id');
    console.log(id);

    getDocs(colRef)
      .then((snapshot) => {
        let books = []
        snapshot.docs.forEach((doc) => {
          // books.push({ ...doc.data(), id: doc.id })
          let time = doc.data().time;
          let seconds = doc.data().time.seconds;
          let date = new Date(seconds);
          let assign = doc.data().assign;
          $('#type').text(`${doc.data().type}`);
          $('#room').text(`${doc.data().room}`);
          $('#time').text(`${date}`);
          $('#floor').text(`${doc.data().floor}`);
          $('#description').text(`${doc.data().description}`);
          console.log(doc.data().time)
          console.log()
          Object.entries(assign).forEach(item => {
            console.log(item)
            $('#innerModal')[0].innerHTML += item.toString();
          })
          // console.log(new Date(doc.data().time.seconds * 1000))
        })
        // console.log(books);
      })
      .catch(err => {
        console.log(err.message);
      })
  })
</script>